<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta property="og:title" content="Linux perf: CPUç·¨">
  
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2016-07-17">
  
  <meta property="og:description" content="">
  <meta property="og:url" content="https://satoshun.github.io/2016/07/linux-perf/">
  <meta property="og:site_name" content="stsnãƒ–ãƒ­ã‚°">
  
  
    <meta property="og:tags" content="linux">
  

  <meta property="twitter:title" content="Linux perf: CPUç·¨">

  
  <meta property="twitter:description" content="Linux perf: CPUç·¨
CPUåˆ©ç”¨ç‡, é«˜è² è·ãªãƒ—ãƒ­ã‚»ã‚¹ã®ç‰¹å®šã®ä»•æ–¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™.
0. lscpu
ã‚·ã‚¹ãƒ†ãƒ ã®ã‚³ã‚¢æ•°,ãƒã‚·ãƒ³ã®ã‚¹ãƒšãƒƒã‚¯ã‚’æœ€åˆã« â€¦">
  

  
  <meta property="twitter:image" content="https://bit.ly/2S8StSM">
  

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Linux perf: CPUç·¨  - stsnãƒ–ãƒ­ã‚° </title>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://satoshun.github.io/css/main.css">
  <link rel="stylesheet" href="https://satoshun.github.io/css/poole.css">
  <link rel="stylesheet" href="https://satoshun.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://satoshun.github.io/css/hyde.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="shortcut icon" href="/favicon.png">

  
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <link href='//fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>

  <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Raleway']
      }
    });
  </script>

  <link rel="stylesheet"
        href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/agate.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/kotlin.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/languages/groovy.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
</head>

<body class="theme-dark">

<section class="site-nav">
  <header class="container">
    <nav id="navigation">
      <a href="/" class="home">Home</a>
      <a href="/blog">Blog</a>
      <a href="/presentation">Presentation</a>
      <a href="/book">Book</a>
    </nav>
  </header>
</section>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Linux perf: CPUç·¨</h1>
    
    <span class="post-date">Created at Sun, Jul 17, 2016</span>
    
    <h1 id="linux-perf-cpuç·¨">Linux perf: CPUç·¨</h1>
<p>CPUåˆ©ç”¨ç‡, é«˜è² è·ãªãƒ—ãƒ­ã‚»ã‚¹ã®ç‰¹å®šã®ä»•æ–¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™.</p>
<h2 id="0-lscpu">0. lscpu</h2>
<p>ã‚·ã‚¹ãƒ†ãƒ ã®ã‚³ã‚¢æ•°,ãƒã‚·ãƒ³ã®ã‚¹ãƒšãƒƒã‚¯ã‚’æœ€åˆã«èª¿ã¹ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@vagrant:~# lscpu
Architecture:          x86_64
CPU op-mode<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:        32-bit, 64-bit
Byte Order:            Little Endian
CPU<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:                <span style="color:#ae81ff">4</span>
On-line CPU<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> list:   0-3
Thread<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> per core:    <span style="color:#ae81ff">1</span>
Core<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> per socket:    <span style="color:#ae81ff">4</span>
Socket<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:             <span style="color:#ae81ff">1</span>
NUMA node<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:          <span style="color:#ae81ff">1</span>
Vendor ID:             GenuineIntel
CPU family:            <span style="color:#ae81ff">6</span>
Model:                 <span style="color:#ae81ff">69</span>
Model name:            Intel<span style="color:#f92672">(</span>R<span style="color:#f92672">)</span> Core<span style="color:#f92672">(</span>TM<span style="color:#f92672">)</span> i7-4650U CPU @ 1.70GHz
Stepping:              <span style="color:#ae81ff">1</span>
CPU MHz:               2300.000
BogoMIPS:              4600.00
Hypervisor vendor:     KVM
Virtualization type:   full
L1d cache:             32K
L1i cache:             32K
L2 cache:              256K
L3 cache:              4096K
NUMA node0 CPU<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:     0-3
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx rdtscp lm constant_tsc rep_good nopl xtopology nonstop_tsc pni pclmulqdq ssse3 cx16 sse4_1 sse4_2 movbe popcnt aes xsave avx rdrand hypervisor lahf_lm abm
</code></pre></div><p>ã‚³ã‚¢æ•°ã¯4, Core i7ã¨ã„ã†ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.</p>
<h2 id="1-uptime">1. uptime</h2>
<p>æ¬¡ã«, ä½•ã¯ã¨ã‚‚ã‚ã‚Œ<code>uptime</code>ã§ã™. ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ™ãƒ¬ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã—ã¾ã™.</p>
<p>ãƒ­ãƒ¼ãƒ‰ã‚¢ãƒ™ãƒ¬ãƒ¼ã‚¸ã®å€¤ã§, ã–ã£ãã‚Šã¨ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®è² è·ã‚’èª¿ã¹ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@vagrant:~# uptime
 10:28:54 up <span style="color:#ae81ff">25</span> min,  <span style="color:#ae81ff">2</span> users,  load average: 0.41, 0.87, 0.59
</code></pre></div><p>ä¸€èˆ¬çš„ã«ã¯, CPUã®ã‚³ã‚¢æ•°å‰å¾ŒãŒåŸºæº–ã¨ãªã‚Šã¾ã™.
ã“ã®å€¤ãŒå¤§ãã„å ´åˆã¯, CPU or ãƒ¡ãƒ¢ãƒª or etcã«, é«˜è² è·ãªãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚Šã¾ã™.</p>
<h2 id="2-mpstat">2. mpstat</h2>
<p>ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®CPUåˆ©ç”¨ç‡ã‚’<code>mpstat</code>ã‚³ãƒãƒ³ãƒ‰ã§èª¿ã¹ã¾ã™.</p>
<p>å€‹åˆ¥ã®ã‚³ã‚¢ã”ã¨ã®åˆ©ç”¨ç‡ã‚’å‡ºåŠ›ã™ã‚‹ <code>-P ALL</code> ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦å®Ÿè¡Œã—ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@vagrant:~# mpstat -P ALL
Linux 4.4.0-21-generic <span style="color:#f92672">(</span>vagrant<span style="color:#f92672">)</span>  07/17/2016  _x86_64_  <span style="color:#f92672">(</span><span style="color:#ae81ff">4</span> CPU<span style="color:#f92672">)</span>

10:27:44 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
10:27:45 AM  all    6.50    0.00   18.25    0.00    0.00    0.00    0.00    0.00    0.00   75.25
10:27:45 AM    <span style="color:#ae81ff">0</span>    0.00    0.00    0.98    0.00    0.00    0.00    0.00    0.00    0.00   99.02
10:27:45 AM    <span style="color:#ae81ff">1</span>    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
10:27:45 AM    <span style="color:#ae81ff">2</span>    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
10:27:45 AM    <span style="color:#ae81ff">3</span>   25.25    0.00   74.75    0.00    0.00    0.00    0.00    0.00    0.00    0.00
</code></pre></div><p>ã“ã®å‡ºåŠ›ã‹ã‚‰, 1ã¤ã®ã‚³ã‚¢ã«å‡¦ç†ãŒé›†ä¸­ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.
ã¾ãŸ, iowaitãŒç™ºç”Ÿã—ã¦ã„ãªã„ã“ã¨ã‹ã‚‰, CPUãƒ‰ãƒªãƒ–ãƒ³ãªãƒ—ãƒ­ã‚»ã‚¹ã¨ã„ã†ã“ã¨ã‚‚åˆ†ã‹ã‚Šã¾ã™.</p>
<h2 id="3-top">3. top</h2>
<p>æ¬¡ã«, ã©ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒCPUã‚’å°‚æœ‰ã—ã¦ã„ã‚‹ã®ã‹ã‚’<code>top</code>ã‚³ãƒãƒ³ãƒ‰ã§èª¿ã¹ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">top - 10:46:54 up <span style="color:#ae81ff">43</span> min,  <span style="color:#ae81ff">2</span> users,  load average: 0.99, 0.67, 0.48
Tasks: <span style="color:#ae81ff">148</span> total,   <span style="color:#ae81ff">2</span> running, <span style="color:#ae81ff">146</span> sleeping,   <span style="color:#ae81ff">0</span> stopped,   <span style="color:#ae81ff">0</span> zombie
%Cpu<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>:  7.4 us, 17.7 sy,  0.0 ni, 74.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :  <span style="color:#ae81ff">4046448</span> total,  <span style="color:#ae81ff">3670180</span> free,    <span style="color:#ae81ff">98452</span> used,   <span style="color:#ae81ff">277816</span> buff/cache
KiB Swap:  <span style="color:#ae81ff">1048572</span> total,  <span style="color:#ae81ff">1048572</span> free,        <span style="color:#ae81ff">0</span> used.  <span style="color:#ae81ff">3895064</span> avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
 <span style="color:#ae81ff">2682</span> root      <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>    <span style="color:#ae81ff">7620</span>    <span style="color:#ae81ff">692</span>    <span style="color:#ae81ff">616</span> R  99.7  0.0   4:38.47 dd
 <span style="color:#ae81ff">2195</span> root      <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">101016</span>  <span style="color:#ae81ff">32260</span>   <span style="color:#ae81ff">9380</span> S   2.3  0.8   0:43.51 glances
 <span style="color:#ae81ff">1019</span> root      <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">409164</span>  <span style="color:#ae81ff">35092</span>  <span style="color:#ae81ff">21860</span> S   0.3  0.9   0:01.99 docker
 <span style="color:#ae81ff">1123</span> www-data  <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">125416</span>   <span style="color:#ae81ff">3148</span>   <span style="color:#ae81ff">1552</span> S   0.3  0.1   0:00.20 nginx
 <span style="color:#ae81ff">1367</span> vagrant   <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">95464</span>   <span style="color:#ae81ff">5128</span>   <span style="color:#ae81ff">4180</span> S   0.3  0.1   0:01.71 sshd
    <span style="color:#ae81ff">1</span> root      <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>   <span style="color:#ae81ff">37968</span>   <span style="color:#ae81ff">6040</span>   <span style="color:#ae81ff">4008</span> S   0.0  0.1   0:01.96 systemd
    <span style="color:#ae81ff">2</span> root      <span style="color:#ae81ff">20</span>   <span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> S   0.0  0.0   0:00.00 kthreadd
...
</code></pre></div><p>pid 2682ã®<code>dd</code>ã‚³ãƒãƒ³ãƒ‰ãŒCPUã‚’å°‚æœ‰ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.
ã“ã‚Œã§, è² è·ãŒé«˜ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç‰¹å®šã§ãã¾ã—ãŸ.</p>
<h2 id="4-strace">4. strace</h2>
<p>æ¬¡ã«, ç‰¹å®šã—ãŸãƒ—ãƒ­ã‚»ã‚¹ãŒã©ã†ã„ã£ãŸã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã‹ã‚’<code>strace</code>ã‚³ãƒãƒ³ãƒ‰ã§èª¿ã¹ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@vagrant:~# strace -p <span style="color:#ae81ff">2682</span>
strace: Process <span style="color:#ae81ff">1376</span> attached
write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
read<span style="color:#f92672">(</span>0, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
read<span style="color:#f92672">(</span>0, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
read<span style="color:#f92672">(</span>0, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
read<span style="color:#f92672">(</span>0, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
write<span style="color:#f92672">(</span>1, <span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span>..., 512<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">512</span>
...
</code></pre></div><p>ddã‚³ãƒãƒ³ãƒ‰ã¯, read, writeã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã‚’ç¹°ã‚Šè¿”ã—ã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™.</p>
<p>ä½™è«‡ã§ã™ãŒ, nginxã®workerãƒ—ãƒ­ã‚»ã‚¹ã‚’straceã™ã‚‹ã¨, ä»¥ä¸‹ã®å‡ºåŠ›ã‚’ã—ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@vagrant:~# strace -p <span style="color:#ae81ff">1118</span>
strace: Process <span style="color:#ae81ff">1118</span> attached
epoll_wait<span style="color:#f92672">(</span>9,
<span style="color:#f92672">[{</span>EPOLLIN, <span style="color:#f92672">{</span>u32<span style="color:#f92672">=</span>1012871416, u64<span style="color:#f92672">=</span>140064191361272<span style="color:#f92672">}}]</span>, 512, -1<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
accept4<span style="color:#f92672">(</span>7, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_INET6, sin6_port<span style="color:#f92672">=</span>htons<span style="color:#f92672">(</span>43248<span style="color:#f92672">)</span>, inet_pton<span style="color:#f92672">(</span>AF_INET6, <span style="color:#e6db74">&#34;::1&#34;</span>, &amp;sin6_addr<span style="color:#f92672">)</span>, sin6_flowinfo<span style="color:#f92672">=</span>0, sin6_scope_id<span style="color:#f92672">=</span>0<span style="color:#f92672">}</span>, <span style="color:#f92672">[</span>28<span style="color:#f92672">]</span>, SOCK_NONBLOCK<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">13</span>
epoll_ctl<span style="color:#f92672">(</span>9, EPOLL_CTL_ADD, 13, <span style="color:#f92672">{</span>EPOLLIN|EPOLLRDHUP|EPOLLET, <span style="color:#f92672">{</span>u32<span style="color:#f92672">=</span>1012871880, u64<span style="color:#f92672">=</span>140064191361736<span style="color:#f92672">}})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
epoll_wait<span style="color:#f92672">(</span>9, <span style="color:#f92672">[{</span>EPOLLIN, <span style="color:#f92672">{</span>u32<span style="color:#f92672">=</span>1012871880, u64<span style="color:#f92672">=</span>140064191361736<span style="color:#f92672">}}]</span>, 512, 60000<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
recvfrom<span style="color:#f92672">(</span>13, <span style="color:#e6db74">&#34;GET / HTTP/1.1\r\nHost: localhost\r&#34;</span>..., 1024, 0, NULL, NULL<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">73</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/&#34;</span>, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFDIR|0755, st_size<span style="color:#f92672">=</span>4096, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/&#34;</span>, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFDIR|0755, st_size<span style="color:#f92672">=</span>4096, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/index.html&#34;</span>, 0x7fffe02ba480<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> -1 ENOENT <span style="color:#f92672">(</span>No such file or directory<span style="color:#f92672">)</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html&#34;</span>, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFDIR|0755, st_size<span style="color:#f92672">=</span>4096, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/index.htm&#34;</span>, 0x7fffe02ba480<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> -1 ENOENT <span style="color:#f92672">(</span>No such file or directory<span style="color:#f92672">)</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/index.nginx-debian.html&#34;</span>, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFREG|0644, st_size<span style="color:#f92672">=</span>612, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
stat<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/index.nginx-debian.html&#34;</span>, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFREG|0644, st_size<span style="color:#f92672">=</span>612, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
open<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/var/www/html/index.nginx-debian.html&#34;</span>, O_RDONLY|O_NONBLOCK<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span>
fstat<span style="color:#f92672">(</span>14, <span style="color:#f92672">{</span>st_mode<span style="color:#f92672">=</span>S_IFREG|0644, st_size<span style="color:#f92672">=</span>612, ...<span style="color:#f92672">})</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
setsockopt<span style="color:#f92672">(</span>13, SOL_TCP, TCP_CORK, <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>, 4<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
writev<span style="color:#f92672">(</span>13, <span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;HTTP/1.1 200 OK\r\nServer: nginx/1&#34;</span>..., 247<span style="color:#f92672">}]</span>, 1<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">247</span>
sendfile<span style="color:#f92672">(</span>13, 14, <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span> <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">[</span>612<span style="color:#f92672">]</span>, 612<span style="color:#f92672">)</span>     <span style="color:#f92672">=</span> <span style="color:#ae81ff">612</span>
write<span style="color:#f92672">(</span>4, <span style="color:#e6db74">&#34;::1 - - [17/Jul/2016:11:27:21 +0&#34;</span>..., 80<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>
close<span style="color:#f92672">(</span>14<span style="color:#f92672">)</span>                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
setsockopt<span style="color:#f92672">(</span>13, SOL_TCP, TCP_CORK, <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>, 4<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
recvfrom<span style="color:#f92672">(</span>13, 0x55583aa2a770, 1024, 0, NULL, NULL<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> -1 EAGAIN <span style="color:#f92672">(</span>Resource temporarily unavailable<span style="color:#f92672">)</span>
epoll_wait<span style="color:#f92672">(</span>9, <span style="color:#f92672">[{</span>EPOLLIN|EPOLLRDHUP, <span style="color:#f92672">{</span>u32<span style="color:#f92672">=</span>1012871880, u64<span style="color:#f92672">=</span>140064191361736<span style="color:#f92672">}}]</span>, 512, 65000<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
recvfrom<span style="color:#f92672">(</span>13, <span style="color:#e6db74">&#34;&#34;</span>, 1024, 0, NULL, NULL<span style="color:#f92672">)</span>   <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
close<span style="color:#f92672">(</span>13<span style="color:#f92672">)</span>                               <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
epoll_wait<span style="color:#f92672">(</span>9,
</code></pre></div><p>ã–ã£ãã‚Šã¨,</p>
<ol>
<li>accept4ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’acceptã™ã‚‹</li>
<li>recvfromã§, ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¸­èº«ã‚’å–å¾—ã™ã‚‹</li>
<li>/var/www/html/index.nginx-debian.htmlã‚’é–‹ã</li>
<li>writev, sendfile, writeã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œæˆã™ã‚‹</li>
<li>closeã§å¾Œå‡¦ç†ã‚’ã™ã‚‹</li>
</ol>
<p>ã¨ã„ã†æ„Ÿã˜ã§ã—ã‚‡ã†ã‹?
<code>strace</code>ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§, å¤§ä½“ã®å‡¦ç†å†…å®¹ãŒåˆ†ã‹ã‚Šã¾ã™.</p>
<h2 id="5-perf">5. perf</h2>
<p>æœ€å¾Œã«, <code>perf</code>ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦, ãƒ—ãƒ­ã‚»ã‚¹ã®CPUåˆ©ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã‚’è¦‹ã¾ã™.</p>
<p>ã¾ãš, pidã‚’æŒ‡å®šã—ã¦, ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">perf record -F <span style="color:#ae81ff">99</span> -p <span style="color:#ae81ff">2682</span> -a -g -- sleep <span style="color:#ae81ff">10</span>
</code></pre></div><p>ãã—ã¦, ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã®çµæœã‚’å‡ºåŠ›ã—ã¾ã™.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">root@vagrant:~# perf report --stdio
no symbols found in /bin/dd, maybe install a debug package?
<span style="color:#75715e"># To display the perf.data header info, please use --header/--header-only options.</span>
#
#
<span style="color:#75715e"># Total Lost Samples: 0</span>
#
<span style="color:#75715e"># Samples: 985  of event &#39;cpu-clock&#39;</span>
<span style="color:#75715e"># Event count (approx.): 9949494850</span>
#
<span style="color:#75715e"># Children      Self  Command  Shared Object      Symbol</span>
<span style="color:#75715e"># ........  ........  .......  .................  .................................</span>
#
    59.80%     0.30%  dd       <span style="color:#f92672">[</span>kernel.kallsyms<span style="color:#f92672">]</span>  <span style="color:#f92672">[</span>k<span style="color:#f92672">]</span> entry_SYSCALL_64_fastpath
                 |
                 |--59.49%-- entry_SYSCALL_64_fastpath
                 |          |
                 |          |--39.59%-- sys_read
                 |          |          |
                 |          |          |--34.72%-- vfs_read
                 |          |          |          |
                 |          |          |          |--19.29%-- __vfs_read
                 |          |          |          |          |
                 |          |          |          |          |--17.87%-- new_sync_read
                 |          |          |          |          |          |
                 |          |          |          |          |          |--14.72%-- read_iter_zero
                 |          |          |          |          |          |          |
                 |          |          |          |          |          |          |--12.49%-- iov_iter_zero
                 |          |          |          |          |          |          |          |
                 |          |          |          |          |          |          |           --10.05%-- __clear_user
                 |          |          |          |          |          |          |
                 |          |          |          |          |          |          |--0.91%-- __clear_user
                 |          |          |          |          |          |          |
                 |          |          |          |          |          |           --0.10%-- apic_timer_interrupt
                 |          |          |          |          |          |                     smp_apic_timer_interrupt
                 |          |          |          |          |          |                     irq_exit
                 |          |          |          |          |          |                     __do_softirq
                 |          |          |          |          |          |
                 |          |          |          |          |          |--0.30%-- iov_iter_zero
                 |          |          |          |          |          |
                 |          |          |          |          |          |--0.30%-- iov_iter_init
                 |          |          |          |          |          |
                 |          |          |          |          |           --0.20%-- _cond_resched
                 |          |          |          |          |
                 |          |          |          |          |--0.91%-- read_iter_zero
                 |          |          |          |          |
                 |          |          |          |           --0.20%-- iov_iter_init
                 |          |          |          |
                 |          |          |          |--10.56%-- rw_verify_area
...
</code></pre></div><p><code>perf</code>ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§, ã‚ˆã‚Šè©³ç´°ãªãƒ—ãƒ­ã‚»ã‚¹ã®å†…å®¹ãŒåˆ†ã‹ã‚Šã¾ã™.</p>
<h2 id="ãã®ä»–">ãã®ä»–</h2>
<ul>
<li>htop: topã®ã„ã„æ„Ÿã˜ç‰ˆ</li>
<li>glances: topã®ã„ã„æ„Ÿã˜ç‰ˆ</li>
<li>sar: CPU + ãƒ¡ãƒ¢ãƒªã®ä½¿ç”¨ç‡ã‚’èª¿ã¹ã‚‹</li>
</ul>

    <div class="mt30"></div>
    
      <ul class="article-post-tags">
        
          <li><a href="/tags/linux">linux</a></li>
        
      </ul>
    
    <footer>
      <address class="address__post">
       <img class="icon__post" src="https://bit.ly/2S8StSM" />
       <p>
        Written by <strong><a rel="author" href="https://twitter.com/stsn_jp" title="Sato Shun" target="_blank">Sato Shun</a></strong><br>
        <span style="display:inline-block; margin-bottom: 4px;" class="muted">ã‚ã‚“ã©ã‚ã„ã©ã§ãƒã¹ã‚ã£ã±ããƒ¼ğŸ</span><br>
        <a style="margin-right: 4px;" rel="twitter-link" href="https://twitter.com/stsn_jp">
        <img style="display:inline;" width="28" height="28" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDQ4IDQ4IiBpZD0iTGF5ZXJfMSIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNDggNDgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxjaXJjbGUgY3g9IjI0IiBjeT0iMjQiIGZpbGw9IiMxQ0I3RUIiIHI9IjI0Ii8+PGc+PGc+PHBhdGggZD0iTTM2LjgsMTUuNGMtMC45LDAuNS0yLDAuOC0zLDAuOWMxLjEtMC43LDEuOS0xLjgsMi4zLTMuMWMtMSwwLjYtMi4xLDEuMS0zLjQsMS40Yy0xLTEuMS0yLjMtMS44LTMuOC0xLjggICAgYy0yLjksMC01LjMsMi41LTUuMyw1LjdjMCwwLjQsMCwwLjksMC4xLDEuM2MtNC40LTAuMi04LjMtMi41LTEwLjktNS45Yy0wLjUsMC44LTAuNywxLjgtMC43LDIuOWMwLDIsMC45LDMuNywyLjMsNC43ICAgIGMtMC45LDAtMS43LTAuMy0yLjQtMC43YzAsMCwwLDAuMSwwLDAuMWMwLDIuNywxLjgsNSw0LjIsNS42Yy0wLjQsMC4xLTAuOSwwLjItMS40LDAuMmMtMC4zLDAtMC43LDAtMS0wLjEgICAgYzAuNywyLjMsMi42LDMuOSw0LjksMy45Yy0xLjgsMS41LTQuMSwyLjQtNi41LDIuNGMtMC40LDAtMC44LDAtMS4zLTAuMWMyLjMsMS42LDUuMSwyLjYsOC4xLDIuNmM5LjcsMCwxNS04LjYsMTUtMTYuMSAgICBjMC0wLjIsMC0wLjUsMC0wLjdDMzUuMiwxNy42LDM2LjEsMTYuNiwzNi44LDE1LjR6IiBmaWxsPSIjRkZGRkZGIi8+PC9nPjwvZz48L3N2Zz4=" />
        </a>
        <a rel="github-link" href="https://github.com/satoshun">
          <img style="display:inline;" width="32" height="32" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGhlaWdodD0iNjdweCIgaWQ9IkxheWVyXzEiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDY3IDY3OyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNjcgNjciIHdpZHRoPSI2N3B4IiB4bWw6c3BhY2U9InByZXNlcnZlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj48cGF0aCBkPSJNMjAuNTQzLDM0LjU2OGMtMC4wNTQsMCwwLjU5MiwxLjM2NywwLjYxLDEuMzY3ICBjMS40MSwyLjUxNiw0LjEyOCw0LjA4LDguNzEzLDQuNTE0Yy0wLjY1NCwwLjQ4OC0xLjQ0LDEuNDE0LTEuNTQ5LDIuNDg0Yy0wLjgyMywwLjUyMy0yLjQ3OCwwLjY5Ni0zLjc2NCwwLjI5NyAgYy0xLjgwMy0wLjU1OS0yLjQ5My00LjA2Ni01LjE5Mi0zLjU2NmMtMC41ODQsMC4xMDctMC40NjgsMC40ODYsMC4wMzcsMC44MDljMC44MjMsMC41MjMsMS41OTcsMS4xNzgsMi4xOTQsMi41NzEgIGMwLjQ1OSwxLjA3LDEuNDIzLDIuOTgxLDQuNDczLDIuOTgxYzEuMjEsMCwyLjA1OC0wLjE0MywyLjA1OC0wLjE0M3MwLjAyMywyLjczMSwwLjAyMywzLjc5M2MwLDEuMjI1LTEuNjgyLDEuNTctMS42ODIsMi4xNTkgIGMwLDAuMjMzLDAuNTU3LDAuMjU1LDEuMDA0LDAuMjU1YzAuODg0LDAsMi43MjMtMC43MjUsMi43MjMtMS45OThjMC0xLjAxMSwwLjAxNy00LjQxLDAuMDE3LTUuMDA2YzAtMS4zLDAuNzA5LTEuNzEyLDAuNzA5LTEuNzEyICBzMC4wODgsNi45NC0wLjE2OSw3Ljg3MmMtMC4zMDIsMS4wOTQtMC44NDcsMC45MzktMC44NDcsMS40MjdjMCwwLjcyNiwyLjIxNCwwLjE3OSwyLjk0OC0xLjQxNmMwLjU2Ny0xLjIzOSwwLjMxOS04LjA1LDAuMzE5LTguMDUgIGwwLjYwNS0wLjAxMmMwLDAsMC4wMzQsMy4xMTcsMC4wMTMsNC41NDJjLTAuMDIxLDEuNDc2LTAuMTIzLDMuMzQyLDAuNzY5LDQuMjIyYzAuNTg2LDAuNTc5LDIuNDg0LDEuNTk0LDIuNDg0LDAuNjY2ICBjMC0wLjUzOS0xLjA0LTAuOTgyLTEuMDQtMi40NDF2LTYuNzE1YzAuODMxLDAsMC43MDYsMi4yMDgsMC43MDYsMi4yMDhsMC4wNjEsNC4xMDNjMCwwLTAuMTg0LDEuNDk0LDEuNjQ1LDIuMTE5ICBjMC42NDUsMC4yMjMsMi4wMjUsMC4yODMsMi4wOS0wLjA5YzAuMDY1LTAuMzczLTEuNjYyLTAuOTI4LTEuNjc4LTIuMDg0Yy0wLjAxLTAuNzA3LDAuMDMyLTEuMTE5LDAuMDMyLTQuMTg3ICBjMC0zLjA2OC0wLjQxOS00LjIwMi0xLjg4LTUuMTA2YzQuNTA4LTAuNDU1LDcuMjk5LTEuNTUxLDguNjU4LTQuNDg2YzAuMTA2LDAuMDAzLDAuNTU1LTEuMzcxLDAuNDk2LTEuMzcxICBjMC4zMDUtMS4xMDgsMC40Ny0yLjQxOSwwLjUwMi0zLjk3MWMtMC4wMDgtNC4yMS0yLjA1OC01LjY5OS0yLjQ1MS02LjM5OGMwLjU4LTMuMTg3LTAuMDk4LTQuNjM3LTAuNDEyLTUuMTM1ICBjLTEuMTYyLTAuNDA2LTQuMDQxLDEuMDQ1LTUuNjE1LDIuMDY3Yy0yLjU2NC0wLjczNy03Ljk4Ni0wLjY2Ni0xMC4wMTksMC4xOWMtMy43NTEtMi42MzktNS43MzYtMi4yMzUtNS43MzYtMi4yMzUgIHMtMS4yODMsMi4yNTktMC4zMzksNS41NjVjLTEuMjM0LDEuNTQ2LTIuMTU0LDIuNjQtMi4xNTQsNS41MzlDMTkuOTA2LDMxLjgzLDIwLjEwMiwzMy4yOTIsMjAuNTQzLDM0LjU2OHogTTMzLDY0ICBDMTYuNDMyLDY0LDMsNTAuNTY4LDMsMzRDMywxNy40MzEsMTYuNDMyLDQsMzMsNHMzMCwxMy40MzEsMzAsMzBDNjMsNTAuNTY4LDQ5LjU2OCw2NCwzMyw2NHoiIHN0eWxlPSJmaWxsLXJ1bGU6ZXZlbm9kZDtjbGlwLXJ1bGU6ZXZlbm9kZDtmaWxsOiMwMTAxMDE7Ii8+PC9zdmc+" />
        </a>
       </p>
      </address>
    </footer>

    <div class="social">
  <div style="margin-right:15px; display: inline-block;">
    <a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical">Tweet</a>
  </div>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
</div>

  </div>
  <div class="mb15"></div>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-44009809-2', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>

</div>
</body>
</html>
